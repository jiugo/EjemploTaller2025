name: Deploy on demand (Frontend or Backend)

on:
  workflow_dispatch:
    inputs:
      app:
        description: "Choose which project to deploy"
        required: true
        type: choice
        options:
          - frontend
          - backend
      dotnet_version:
        description: ".NET SDK version"
        required: false
        default: "8.x"
        type: string

permissions:
  contents: read

env:
  CONFIGURATION: Release
  PUBLISH_DIR: publish

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ github.event.inputs.dotnet_version }}

      # Descubrir rutas reales de los csproj (tolerante a espacios y subcarpetas)
      - name: Locate project files
        shell: pwsh
        run: |
          $fe = Get-ChildItem -Path . -Recurse -Filter Frontend.csproj | Select-Object -First 1
          $be = Get-ChildItem -Path . -Recurse -Filter Backend.csproj  | Select-Object -First 1

          if (-not $fe) { Write-Error "Frontend.csproj not found in repo" }
          if (-not $be) { Write-Error "Backend.csproj not found in repo" }

          "FRONTEND_PROJECT=$($fe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "BACKEND_PROJECT=$($be.FullName)"  | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Write-Host "Frontend project: $($fe.FullName)"
          Write-Host "Backend project:  $($be.FullName)"

      # Frontend
      - name: Restore (frontend)
        if: ${{ github.event.inputs.app == 'frontend' }}
        run: dotnet restore "${{ env.FRONTEND_PROJECT }}"
      - name: Publish (frontend)
        if: ${{ github.event.inputs.app == 'frontend' }}
        run: dotnet publish "${{ env.FRONTEND_PROJECT }}" -c "${{ env.CONFIGURATION }}" -o "${{ env.PUBLISH_DIR }}"

      # Backend
      - name: Restore (backend)
        if: ${{ github.event.inputs.app == 'backend' }}
        run: dotnet restore "${{ env.BACKEND_PROJECT }}"
      - name: Publish (backend)
        if: ${{ github.event.inputs.app == 'backend' }}
        run: dotnet publish "${{ env.BACKEND_PROJECT }}" -c "${{ env.CONFIGURATION }}" -o "${{ env.PUBLISH_DIR }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ github.event.inputs.app }}
          path: ${{ env.PUBLISH_DIR }}

      # Deploy con Publish Profile (pon√© los secrets en el repo o environment)
      - name: Deploy Frontend to Azure Web App
        if: ${{ github.event.inputs.app == 'frontend' }}
        uses: azure/webapps-deploy@v3
        with:
          publish-profile: ${{ secrets.FRONTEND_PUBLISH_PROFILE }}
          package: ${{ env.PUBLISH_DIR }}

      - name: Deploy Backend to Azure Web App
        if: ${{ github.event.inputs.app == 'backend' }}
        uses: azure/webapps-deploy@v3
        with:
          publish-profile: ${{ secrets.BACKEND_PUBLISH_PROFILE }}
          package: ${{ env.PUBLISH_DIR }}

